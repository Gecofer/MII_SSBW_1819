<!DOCTYPE html>
<html lang="es">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

	<title>Bases de datos NO-SQL</title>
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
			integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">

	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.11.0/themes/prism.min.css">
	<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.11.0/prism.js"></script>
 	<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.11.0/components/prism-python.min.js"></script>
 	<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.11.0/components/prism-bash.min.js"></script>
 	<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.11.0/components/prism-markup.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.11.0/components/prism-yaml.min.js"></script>
 	<style>
		body {
			padding-top: 3em;
		}
		p {
			padding-top: 0.5em;
		}
		h2 {
			padding-bottom: 1em;
		}
		h3 {
			padding-top: 1em;
		}


	</style>
</head>
<body>
	<div class="container">

		<h2>Base de Datos MongoDB</h2>
		<p>
			En esta tarea instalaremos y usaremos la base de datos no-sql
			<a href="https://docs.mongodb.com/manual/tutorial/getting-started/">MongoDB</a>
  	   </p>
		<p>
			Crearemos un servicio para mongodb en nuestro <b>docker-compose.yml</b>,
			usando la <a href="https://hub.docker.com/_/mongo">image oficial de mongodb</a>
<pre><code class="language-yaml">version: '3'
services:
	  mongo:
	    image: mongo:4.0
	    volumes:
	      - ./datos_db:/data/db
	      - .:/datos

	  mongo-express:
	    image: mongo-express
	    ports:
	      - 8081:8081
		 depends_on:
		 	- mongo

	  web:
	    build: .
	    command: python manage.py runserver 0.0.0.0:8000
	    volumes:
		 	- .:/code
	    ports:
		 	- 8000:8000
	    links:
		 	- mongo
		 depends_on:
		 	- mongo</code></pre><br/>

donde se ha añadido un servicio más: <a href="https://github.com/mongo-express/mongo-express#readme">mongo-express</a>, para tener una
GUI de la base de datos. El segundo volumen del servicio mongo, servirá para importar los datos iniciales de la BD.
		</p>
		<p>
			Los datos los bajamos de <a href="https://raw.githubusercontent.com/steveren/docs-assets/charts-tutorial/movieDetails.json">
				https://raw.githubusercontent.com/steveren/docs-assets/charts-tutorial/movieDetails.json</a> y los importamos a la bd
				con la utilidad <code>mongoimport</code>
<pre><code class="language-bash">&gt; docker-compose exec mongo mongoimport --db movies --collection pelis --file /datos/movieDetails.json
</code></pre>
y podremos ver que todo haya ido bien  en <a href="http://localhost:8081">http://localhost:8081</a>. Editando un documento desde la
GUI podremos ver la estructura de la collección.
		</p>
		<h3>Usando pymongo</h3>
		<p>
			Haremos algunas consultas en la BD usando el cliente <a href="http://api.mongodb.com/python/current/tutorial.html">pymongo</a>.
			Para instalarlo hay que poner en el archivo <b>requeriments.txt</b>
			<pre><code class="language-txt">...
mongoengine==0.16</code></pre>
		Así se instalarán los dos clientes de MongoDB que vamos a usar, puesto que monogoengine es una capa de software por encima de pymongo.
	   </p>
		<p>
		Hacer algunas consultas que usen pymongo.
	 	</p>
	 	<h3>Usando mongoengine</h3>
		<p>
			En nuestra aplicación definitiva usaremos <a href="http://mongoengine.org/">monogoengine</a>, que es un
			<a href="https://programarfacil.com/blog/que-es-un-orm/">ORM</a> muy
			inspirado en el <a href="https://docs.djangoproject.com/en/2.2/topics/db/models/">model</a> de Django.
		</p>
		<p>
			Haremos una nueva aplicación en nuestro proyecto:
			<pre><code class="language-bash">$ docker-compose run web python manage.py startapp pelis</code></pre>
		y en el archivo <b>models.py</b>:
<pre><code class="language-python"># models.py
-----------

from mongoengine import *

connect('movies', host='mongo')

class Pelis(Document):
	title     = StringField(required=True)
	year      = IntField(min_value=1900)
	rated     = StringField()
	runtime   = IntField()
	countries = ListField(StringField())
	...
</code></pre>
Hacer las mismas consultas que con pymongo.
		</p>
	</div>
</body>
</html>
